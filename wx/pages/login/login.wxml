<!-- 登录页面（整合微信登录、账号登录/注册与自动绑定） -->
<view class="container">
  <view class="header">
    <text class="icon">🔐</text>
    <text class="title">登录</text>
    <text class="desc">
      {{ wxLoginLoading ? '正在进行微信一键登录…' : (needBind ? '当前微信未绑定，请选择登录或注册完成绑定' : '正在验证微信登录…') }}
    </text>
  </view>

  <!-- 未绑定时显示账号登录/注册选项 -->
  <view wx:if="{{needBind}}">
    <view class="tabs">
      <view 
        class="tab {{activeTab === 0 ? 'active' : ''}}" 
        bindtap="switchTab"
        data-index="0"
      >
        账号登录
      </view>
      <view 
        class="tab {{activeTab === 1 ? 'active' : ''}}" 
        bindtap="switchTab"
        data-index="1"
      >
        注册新账号
      </view>
    </view>

    <!-- 登录表单 -->
    <view class="form-section" wx:if="{{activeTab === 0}}">
      <view class="input-group">
        <view class="input-label">
          <text class="icon">👤</text>
          <text>用户名</text>
        </view>
        <input 
          class="input-field" 
          type="text" 
          placeholder="请输入用户名（2-20位）"
          value="{{loginForm.username}}"
          bindinput="onLoginUsernameInput"
          confirm-type="done"
          maxlength="20"
        />
      </view>

      <view class="input-group">
        <view class="input-label">
          <text class="icon">🔒</text>
          <text>密码</text>
        </view>
        <input 
          class="input-field" 
          type="text"
          password="{{!showLoginPassword}}"
          placeholder="请输入密码（6-20位）"
          value="{{loginForm.password}}"
          bindinput="onLoginPasswordInput"
          confirm-type="done"
          maxlength="20"
        />
        <image 
          class="toggle-password" 
          src="{{showLoginPassword ? '/images/yanjing_xianshi.png' : '/images/yanjing_yincang.png'}}" 
          bindtap="toggleLoginPassword"
          mode="aspectFit"
        />
      </view>

      <view class="actions-row">
        <navigator url="/pages/forgot-password/forgot-password" class="link-btn">忘记密码</navigator>
      </view>

      <button 
        class="submit-btn" 
        bindtap="userLogin"
        loading="{{loginLoading}}"
        disabled="{{loginLoading || loginDisabled}}"
      >
        {{loginLoading ? '登录中...' : '登录'}}
      </button>
    </view>

    <!-- 注册表单（邮箱可选） -->
    <view class="form-section" wx:if="{{activeTab === 1}}">
      <view class="input-group">
        <view class="input-label">
          <text class="icon">👤</text>
          <text>用户名</text>
        </view>
        <input 
          class="input-field" 
          type="text" 
          placeholder="请输入用户名（2-20位）"
          value="{{registerForm.username}}"
          bindinput="onRegisterUsernameInput"
          confirm-type="done"
          maxlength="20"
        />
      </view>

      <view class="input-group">
        <view class="input-label">
          <text class="icon">📧</text>
          <text>邮箱（可选）</text>
        </view>
        <input 
          class="input-field" 
          type="text" 
          placeholder="请输入邮箱（可留空）"
          value="{{registerForm.email}}"
          bindinput="onRegisterEmailInput"
          confirm-type="done"
          maxlength="50"
        />
      </view>

      <view class="input-group">
        <view class="input-label">
          <text class="icon">🔒</text>
          <text>密码</text>
        </view>
        <input 
          class="input-field" 
          type="text"
          password="{{!showRegisterPassword}}"
          placeholder="请输入密码（6-20位）"
          value="{{registerForm.password}}"
          bindinput="onRegisterPasswordInput"
          confirm-type="done"
          maxlength="20"
        />
        <image 
          class="toggle-password" 
          src="{{showRegisterPassword ? '/images/yanjing_xianshi.png' : '/images/yanjing_yincang.png'}}" 
          bindtap="toggleRegisterPassword"
          mode="aspectFit"
        />
      </view>

      <button 
        class="submit-btn" 
        bindtap="userRegister"
        loading="{{registerLoading}}"
        disabled="{{registerLoading || registerDisabled}}"
      >
        {{registerLoading ? '注册中...' : '注册'}}
      </button>

      <view class="tip-sub">
        <text>注册即表示同意平台的相关使用规范</text>
      </view>
    </view>

    <view class="tip">
      <text class="tip-icon">💡</text>
      <text class="tip-text">登录/注册时会自动绑定当前微信，下次可直接一键登录</text>
    </view>
  </view>

  <!-- 辅助操作：允许重新尝试微信登录 -->
  <view wx:if="{{!needBind}}">
    <view class="tip">
      <text class="tip-icon">🔄</text>
      <text class="tip-text">如长时间未响应，可重新尝试微信登录</text>
    </view>
    <button 
      class="submit-btn" 
      bindtap="wechatLogin"
      loading="{{wxLoginLoading}}"
      disabled="{{wxLoginLoading}}"
    >
      {{wxLoginLoading ? '微信登录中...' : '重新尝试微信登录'}}
    </button>
  </view>

  <view class="safe-area-bottom"></view>
</view>
